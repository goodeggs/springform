// Generated by CoffeeScript 1.7.1
var Gate, Springform,
  __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
  __slice = [].slice;

Springform = (function() {
  function Springform(attrs) {
    var field, key, value, _i, _len, _ref;
    if (attrs == null) {
      attrs = {};
    }
    this.submit = __bind(this.submit, this);
    for (key in attrs) {
      value = attrs[key];
      this[key] = value;
    }
    if (this.fieldErrors == null) {
      this.fieldErrors = {};
    }
    this.formError = null;
    this.validators = this.validators ? this.validators.slice() : [];
    if (this.fields == null) {
      this.fields = [];
    }
    _ref = this.fields;
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      field = _ref[_i];
      this.fields[field.name] = field;
    }
  }

  Springform.prototype.bind = function(data) {
    this.data = data;
    return this;
  };

  Springform.prototype.prunedData = function() {
    return _(data).pick(_(this.fields).pluck('name'));
  };

  Springform.prototype.errors = function(errors) {
    if (arguments.length) {
      this.formError = errors.formError;
      this.fieldErrors = errors.fieldErrors || {};
      return this;
    } else {
      return {
        formError: this.formError,
        fieldErrors: this.fieldErrors
      };
    }
  };

  Springform.prototype.validator = function(validator) {
    this.validators.push(validator);
    return this;
  };

  Springform.prototype.validate = function(done) {
    var gate, validator, _i, _len, _ref;
    this.formError = null;
    this.fieldErrors = {};
    gate = new Gate();
    _ref = this.validators || [];
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      validator = _ref[_i];
      if (validator.length > 1) {
        validator(this, gate.callback());
      } else {
        validator(this);
      }
    }
    gate.finished(done);
    return this;
  };

  Springform.prototype.hasErrors = function() {
    return Boolean(this.formError) || Object.keys(this.fieldErrors).some((function(_this) {
      return function(key) {
        return Boolean(_this.fieldErrors[key]);
      };
    })(this));
  };

  Springform.prototype.submit = function(event) {
    if (event != null) {
      event.preventDefault();
    }
    if (this.processing) {
      return;
    }
    this.processing = true;
    return this.process((function(_this) {
      return function() {
        return _this.processing = false;
      };
    })(this));
  };

  Springform.prototype.process = function(done) {
    return done();
  };

  Springform.prototype.processor = function(process) {
    this.process = process;
    return this;
  };

  return Springform;

})();

Springform.required = function() {
  var fields;
  fields = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
  return function(_arg) {
    var data, field, fieldErrors, value, _i, _len, _results;
    data = _arg.data, fieldErrors = _arg.fieldErrors;
    _results = [];
    for (_i = 0, _len = fields.length; _i < _len; _i++) {
      field = fields[_i];
      value = data[field];
      if (!(value || value === false)) {
        _results.push(fieldErrors[field] = 'required');
      } else {
        _results.push(void 0);
      }
    }
    return _results;
  };
};

Gate = (function() {
  function Gate() {
    this.callbacks = [];
    this.returnedCount = 0;
  }

  Gate.prototype.checkDone = function() {
    if (this.returnedCount === this.callbacks.length) {
      return setTimeout(this.done, 0);
    }
  };

  Gate.prototype.callback = function() {
    var callback, called;
    called = false;
    callback = (function(_this) {
      return function() {
        if (called) {
          return;
        }
        called = true;
        _this.returnedCount += 1;
        return _this.checkDone();
      };
    })(this);
    this.callbacks.push(callback);
    return callback;
  };

  Gate.prototype.finished = function(callback) {
    this.done = callback;
    return this.checkDone();
  };

  return Gate;

})();

if (typeof module !== "undefined" && module !== null) {
  module.exports = Springform;
}
